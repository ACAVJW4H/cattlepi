# export important params

# inspired by https://stackoverflow.com/questions/8350942/how-to-re-run-the-curl-command-automatically-when-the-error-occurs/8351489#8351489
with_backoff() 
{
  local max_attempts=${ATTEMPTS-5}
  local timeout=${TIMEOUT-1}
  local attempt=1
  local exitCode=0

  while (( $attempt < $max_attempts ))
  do
    if "$@"
    then
      return 0
    else
      exitCode=$?
    fi

    echo "Failure! Retrying in $timeout.." 1>&2
    sleep $timeout
    attempt=$(( attempt + 1 ))
    timeout=$(( timeout * 2 ))
  done
  return $exitCode
}

cattlepi_find_params()
{
    if [ "${cattlepi_find_params_used}" != "yes" ]; then
        for x in $(cat /proc/cmdline); do
            case $x in
            cattlepi_base=*)
                CATTLEPI_BASE=${x#cattlepi_base=}
                ;;
            cattlepi_apikey=*)
                CATTLEPI_APIKEY=${x#cattlepi_apikey=}
                ;;
            cattlepi_id=*)
                CATTLEPI_APIKEY=${x#cattlepi_id=}
                ;;
            cattlepi_dir=*)
                CATTLEPI_ID=${x#cattlepi_dir=}
                ;;
            esac
        done
        # set default values
        CATTLEPI_BASE=${CATTLEPI_BASE-'http://192.168.0.1:4567'}    
        CATTLEPI_DIR=${CATTLEPI_DIR-'/boot/cattlepi'}
        mkdir -p "${CATTLEPI_DIR}"

        # pick it up from kernel boot param, if not from file and if not either give it default value
        if [ -z ${CATTLEPI_APIKEY+x} ]; then
            [ -r "${CATTLEPI_DIR}/apikey" ] && CATTLEPI_APIKEY=$(head -n 1 "${CATTLEPI_DIR}/apikey")
            CATTLEPI_APIKEY=${CATTLEPI_APIKEY-'5a1eab1e-1857-b33f-b005-c001deadbeef'}
        fi

        # same as with the api key
        if [ -z ${CATTLEPI_ID+x} ]; then
            CATTLEPI_MAC=$(cat /sys/class/net/*/address | grep -v ^00: | sort | head -n 1)
            [ -r "${CATTLEPI_DIR}/id" ] && CATTLEPI_ID=$(head -n 1 "${CATTLEPI_DIR}/id")
            CATTLEPI_ID=${CATTLEPI_ID-$CATTLEPI_MAC}
        fi
        export CATTLEPI_BASE
        export CATTLEPI_APIKEY
        export CATTLEPI_DIR
        export CATTLEPI_ID
    fi
    cattlepi_find_params_used=yes 
}

cattlepi_download()
{
    cattlepi_find_params        
    local downloc outloc
    downloc="$1"
    outloc="$2"
    with_backoff curl -fsSL -H "X-Api-Key: $CATTLEPI_APIKEY" $CATTLEPI_BASE/$downloc -o $outloc
}