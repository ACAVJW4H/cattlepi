---
- hosts: buildernodes
  remote_user: pi
  become: yes
  become_method: sudo
  tasks:
    - file: 
        path: /tmp/ramdisk
        state: absent
    - file: 
        path: /tmp/ramdisk.tgz
        state: absent
    - file: 
        path: /tmp/ramdisk
        state: directory
        mode: 0755
    - file:
        path: /tmp/resources
        state: absent
    - file:
        path: /tmp/output
        state: absent
    - lineinfile:
        path: /etc/initramfs-tools/modules 
        line: squashfs
    - lineinfile:
        path: /usr/share/initramfs-tools/init
        line: . /scripts/cattlepi
        insertbefore: '^\.\s\/scripts\/\${BOOT}'
    - copy:
        src: resources
        dest: /tmp
        owner: root
        group: root
        mode: 0755
    - name: bring in the cattlepi initramfs script
      shell: cp -R /tmp/resources/usr /
    - name: create the ramdisk file
      shell: mkinitramfs -v -o /tmp/ramdisk/cattleinit.gz
    - name: set ramdisk permissions
      shell: chmod 0755 /tmp/ramdisk/cattleinit.gz
    - name: bring in the rest of boot
      shell: /bin/cp -R /boot/* /tmp/ramdisk/
    - lineinfile:
        path: /tmp/ramdisk/config.txt
        line: initramfs cattleinit.gz followkernel
    - lineinfile:
        path: /tmp/ramdisk/config.txt
        line: bootdelay=2
    - name: build the cmdline
      shell: echo "dwc_otg.lpm_enable=0 console=tty1 boot=cattlepi earlyprintk elevator=deadline root=/dev/ram0 rw rootwait initrd=-1" > /tmp/ramdisk/cmdline.txt
    - name: set cmline permissions
      shell: chmod 0755 /tmp/ramdisk/cmdline.txt
    - archive:
        path: /tmp/ramdisk/
        dest: /tmp/ramdisk.tgz
    - fetch:
        src: /tmp/ramdisk.tgz
        dest: output/
        flat: true
